<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Veículos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .sidebar { transition: width 0.3s; }
        .sidebar-collapsed { width: 60px; }
        .sidebar-expanded { width: 200px; }
        .content { transition: margin-left 0.3s; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar sidebar-expanded bg-blue-800 text-white p-4">
            <button id="toggleSidebar" class="text-white mb-4 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            <a href="#" class="block py-2 px-4 hover:bg-blue-700" onclick="showSection('relatorios')">Relatórios</a>
            <a href="#" class="block py-2 px-4 hover:bg-blue-700" onclick="showSection('graficos')">Gráficos</a>
            <a href="#" class="block py-2 px-4 hover:bg-blue-700" onclick="showSection('upload')">Upload</a>
            <a href="{{ url_for('logout') }}" class="block py-2 px-4 hover:bg-blue-700">Sair</a>
        </div>
        <!-- Content -->
        <div class="flex-1 p-6 content" id="content">
            <div class="mb-4">
                <label for="dateSelector" class="block text-sm font-medium text-gray-700">Selecionar Data</label>
                <select id="dateSelector" class="p-2 border rounded" onchange="loadData(this.value)">
                    <option value="">Selecione uma data</option>
                </select>
            </div>
            <section id="relatorios" class="">
                <h2 class="text-2xl font-bold mb-4">Relatórios</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="report-marca" class="mb-4">
                        <h3 class="text-lg font-semibold">Veículos por Marca</h3>
                        <ul id="report-marca-content"></ul>
                    </div>
                    <div id="report-tdv" class="mb-4">
                        <h3 class="text-lg font-semibold">Veículos por TDV</h3>
                        <ul id="report-tdv-content"></ul>
                    </div>
                    <div id="report-tdv-unidade">
                        <h3 class="text-lg font-semibold">Veículos por TDV e Unidade</h3>
                        <table class="w-full border-collapse border">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border p-2">TDV</th>
                                    <th class="border p-2">Unidade</th>
                                    <th class="border p-2">Quantidade</th>
                                </tr>
                            </thead>
                            <tbody id="report-tdv-unidade-content"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <section id="graficos" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Gráficos</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold mb-2">Status Patrimônio</h3>
                    <canvas id="chart-status-patrimonio" class="mb-4"></canvas>
                    <h3 class="text-lg font-semibold mb-2">Disponibilidade por Unidade</h3>
                    <canvas id="chart-disponibilidade"></canvas>
                </div>
            </section>
            <section id="upload" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Upload de Planilha</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <input type="file" name="file" accept=".xlsx" class="p-2 border rounded mb-4">
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Enviar</button>
                    </form>
                    <p id="uploadMessage" class="mt-4 hidden"></p>
                </div>
            </section>
        </div>
    </div>
    <script>
        let statusPatrimonioChart, disponibilidadeChart;

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(section => section.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            if (sectionId === 'graficos' && document.getElementById('dateSelector').value) {
                loadGraficos(document.getElementById('dateSelector').value);
            }
            if (sectionId === 'relatorios' && document.getElementById('dateSelector').value) {
                loadRelatorios(document.getElementById('dateSelector').value);
            }
        }

        document.getElementById('toggleSidebar').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            sidebar.classList.toggle('sidebar-expanded');
            sidebar.classList.toggle('sidebar-collapsed');
            content.classList.toggle('ml-60');
            content.classList.toggle('ml-200');
        });

        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const message = document.getElementById('uploadMessage');
                if (data.error) {
                    message.textContent = 'Erro: ' + data.error;
                    message.classList.add('text-red-500');
                } else {
                    message.textContent = 'Upload concluído! Relatório gerado.';
                    message.classList.add('text-green-500');
                    loadDates(); // Atualizar seletor de datas
                }
                message.classList.remove('hidden');
            })
            .catch(error => {
                document.getElementById('uploadMessage').textContent = 'Erro ao enviar arquivo';
                document.getElementById('uploadMessage').classList.add('text-red-500');
                document.getElementById('uploadMessage').classList.remove('hidden');
            });
        });

        function loadDates() {
            fetch('/dates')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('dateSelector');
                    selector.innerHTML = '<option value="">Selecione uma data</option>';
                    data.dates.forEach(date => {
                        const option = document.createElement('option');
                        option.value = date;
                        option.textContent = date;
                        selector.appendChild(option);
                    });
                });
        }

        function loadRelatorios(date) {
            if (!date) return;
            // Relatório por Marca
            fetch(`/report/${date}`)
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('report-marca-content');
                    content.innerHTML = '';
                    if (data.error) {
                        content.innerHTML = `<li class="text-red-500">${data.error}</li>`;
                        return;
                    }
                    for (const [marca, count] of Object.entries(data.report)) {
                        const li = document.createElement('li');
                        li.textContent = `${marca}: ${count} veículos`;
                        content.appendChild(li);
                    }
                });

            // Relatório por TDV
            fetch(`/report/${date}/tdv`)
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('report-tdv-content');
                    content.innerHTML = '';
                    if (data.error) {
                        content.innerHTML = `<li class="text-red-500">${data.error}</li>`;
                        return;
                    }
                    for (const [tdv, count] of Object.entries(data.report)) {
                        const li = document.createElement('li');
                        li.textContent = `${tdv}: ${count} veículos`;
                        content.appendChild(li);
                    }
                });

            // Relatório por TDV e Unidade
            fetch(`/report/${date}/tdv_unidade`)
                .then(response => response.json())
                .then(data => {
                    const content = document.getElementById('report-tdv-unidade-content');
                    content.innerHTML = '';
                    if (data.error) {
                        content.innerHTML = `<tr><td colspan="3" class="text-red-500 p-2">${data.error}</td></tr>`;
                        return;
                    }
                    data.report.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td class="border p-2">${row.Tdv}</td>
                            <td class="border p-2">${row.Unidade}</td>
                            <td class="border p-2">${row.Quantidade}</td>
                        `;
                        content.appendChild(tr);
                    });
                });
        }

        function loadGraficos(date) {
            if (!date) return;
            // Gráfico de Status Patrimônio
            fetch(`/chart/${date}/status_patrimonio`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('chart-status-patrimonio').parentElement.innerHTML = `<p class="text-red-500">${data.error}</p>`;
                        return;
                    }
                    if (statusPatrimonioChart) statusPatrimonioChart.destroy();
                    const ctx = document.getElementById('chart-status-patrimonio').getContext('2d');
                    statusPatrimonioChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.chart.labels,
                            datasets: [{
                                label: 'Status Patrimônio',
                                data: data.chart.values,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                });

            // Gráfico de Disponibilidade
            fetch(`/chart/${date}/disponibilidade`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('chart-disponibilidade').parentElement.innerHTML = `<p class="text-red-500">${data.error}</p>`;
                        return;
                    }
                    if (disponibilidadeChart) disponibilidadeChart.destroy();
                    const ctx = document.getElementById('chart-disponibilidade').getContext('2d');
                    disponibilidadeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.chart.labels,
                            datasets: data.chart.datasets
                        },
                        options: {
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                });
        }

        // Carregar datas na inicialização
        loadDates();
    </script>
</body>
</html>